{% extends "%s/2019/base_chapter.html" % lang %}

<!--{# IMPORTANT!

- `chapter.html` is a "template for templates" used by the `generate_chapters.js` script, hence the strange template syntax (eg, mixing ejs and jinja syntax)
- if you want to modify `chapter.html`, you must also:
  - translate the corresponding language-specific templates (eg `src/templates/<lang>/<year>/chapter.html`)
  - run the generation script to update each chapter template
- if you want to modify the chapter templates (eg `src/templates/<lang>/<year>/chapters/<chapter>.html`):
  - make changes to the markdown content directly (`src/content/<lang>/<year>/<chapter>.md`) because any changes to the chapter templates will be overwritten by the generation script
#}-->

{% set metadata = {"part_number":"II","chapter_number":8,"title":"セキュリティ","description":"トランスポート・レイヤー・セキュリティ(TLS()、混合コンテンツ、セキュリティヘッダ、Cookie、サブリソース完全性を網羅した2019年版Web Almanacのセキュリティの章。","authors":["ScottHelme","arturjanc"],"reviewers":["bazzadp","ghedo","paulcalvano"],"translators":["ksakae"],"discuss":"1763","results":"https://docs.google.com/spreadsheets/d/1Zq2tQhPE06YZUcbzryRrBE6rdZgHHlqEp2XcgS37cm8/","queries":"08_Security","published":"2019-11-11T00:00:00.000Z","last_updated":"2019-11-23T00:00:00.000Z","chapter":"security"} %} {% block index %}
<ul>
  <li>
    <a href="#序章">序章</a>
  </li>

  <li>
    <a href="#トランスポートレイヤーセキュリティ">トランスポートレイヤーセキュリティ</a>

    <ul>
      <li>
        <a href="#プロトコルのバージョン">プロトコルのバージョン</a>
      </li>

      <li>
        <a href="#証明書発行者">証明書発行者</a>
      </li>

      <li>
        <a href="#認証キーの種類">認証キーの種類</a>
      </li>

      <li>
        <a href="#forward-secrecy">Forward secrecy</a>
      </li>

      <li>
        <a href="#暗号スイート">暗号スイート</a>
      </li>
    </ul>
  </li>

  <li>
    <a href="#混合コンテンツ">混合コンテンツ</a>
  </li>

  <li>
    <a href="#セキュリティヘッダ">セキュリティヘッダ</a>

    <ul>
      <li>
        <a href="#http-strict-transport-security">HTTP Strict Transport Security</a>

        <ul>
          <li>
            <a href="#hstsプリロード">HSTSプリロード</a>
          </li>
        </ul>
      </li>

      <li>
        <a href="#コンテンツセキュリティポリシー">コンテンツセキュリティポリシー</a>

        <ul>
          <li>
            <a href="#ハッシュノンス">ハッシュ/ノンス</a>
          </li>

          <li>
            <a href="#strict-dynamic">strict-dynamic</a>
          </li>

          <li>
            <a href="#trusted-types">trusted-types</a>
          </li>

          <li>
            <a href="#unsafe-inlineとunsafe-eval">unsafe inlineとunsafe-eval</a>
          </li>

          <li>
            <a href="#upgrade-insecure-requests">upgrade-insecure-requests</a>
          </li>

          <li>
            <a href="#frame-ancestors">frame-ancestors</a>
          </li>
        </ul>
      </li>

      <li>
        <a href="#参照元ポリシー">参照元ポリシー</a>
      </li>

      <li>
        <a href="#機能方針">機能方針</a>
      </li>

      <li>
        <a href="#x-frame-options">X-Frame-Options</a>
      </li>

      <li>
        <a href="#x-content-type-options">X-Content-Type-Options</a>
      </li>

      <li>
        <a href="#x-xss-protection">X-XSS-Protection</a>
      </li>

      <li>
        <a href="#report-to">Report-To</a>
      </li>

      <li>
        <a href="#ネットワークエラーロギング">ネットワークエラーロギング</a>
      </li>

      <li>
        <a href="#クリアサイトデータ">クリアサイトデータ</a>
      </li>
    </ul>
  </li>

  <li>
    <a href="#クッキー">クッキー</a>

    <ul>
      <li>
        <a href="#secure">Secure</a>
      </li>

      <li>
        <a href="#httponly">HttpOnly</a>
      </li>

      <li>
        <a href="#samesite">SameSite</a>
      </li>

      <li>
        <a href="#プレフィックス">プレフィックス</a>
      </li>
    </ul>
  </li>

  <li>
    <a href="#サブリソースの完全性">サブリソースの完全性</a>
  </li>

  <li>
    <a href="#結論">結論</a>

    <ul>
      <li>
        <a href="#暗号化">暗号化</a>
      </li>

      <li>
        <a href="#一般的なウェブの脆弱性からの防御">一般的なウェブの脆弱性からの防御</a>
      </li>

      <li>
        <a href="#現代のウェブプラットフォームの防御">現代のウェブプラットフォームの防御</a>
      </li>
    </ul>
  </li>

  <li>
    <a href="#結びつき">結びつき</a>
  </li>
</ul>

{% endblock %} {% block main_content %}
<h2 id="序章"><a href="#序章" class="anchor-link">序章</a></h2>
<p>Web Almanacのこの章では、Web上のセキュリティの現状を見ていきます。オンラインでのセキュリティとプライバシーの重要性がますます高まる中、サイト運営者とユーザーを保護するための機能が増えています。ここでは、ウェブ上でのこれらの新機能の採用状況を見ていきます。</p>
<h2 id="トランスポートレイヤーセキュリティ"><a href="#トランスポートレイヤーセキュリティ" class="anchor-link">トランスポートレイヤーセキュリティ</a></h2>
<p>現在、オンラインでのセキュリティとプライバシーを向上させるための最大の後押しは、おそらくトランスポート・レイヤー・セキュリティ（TLS）の普及です。TLS（または古いバージョンのSSL）は、HTTPSの「S」を提供し、安全でプライベートなWebサイトのブラウジングを可能にするプロトコルです。<a href="https://httparchive.org/reports/state-of-the-web#pctHttps">ウェブ上でのHTTPSの使用が大幅に増加している</a>だけでなく、TLSv1.2やTLSv1.3のような最新バージョンのTLSが増加していることも重要です。</p>
<figure id="fig-1">
  <a href="/static/images/2019/security/fig1.png">
    <img src="/static/images/2019/security/fig1.png" alt="図1.HTTPとHTTPS の使用法。" aria-labelledby="fig1-caption" aria-describedby="fig1-description" width="760" height="470" data-width="760" data-height="470" data-seamless="" data-frameborder="0" data-scrolling="no" data-iframe="https://docs.google.com/spreadsheets/d/e/2PACX-1vRCG3clMcnkVPrnZSCWFi3qG-EU00Qr8X3XaRFQPWHEXQmYWMxnS_kfmmyMQsPZe2P6ECjzCjG0dVFg/pubchart?oid=933123879&amp;format=interactive" loading="lazy" />
  </a>
  <div id="fig1-description" class="visually-hidden">横棒グラフは、モバイルのHTTPSが79%、HTTPが21%、その下にデスクトップのHTTPSが 80.51%、HTTPが19.49%であることを示しています。</div>
  <figcaption id="fig1-caption"><a href="#fig-1" class="anchor-link">図 1.</a>HTTPとHTTPS の使用法。</figcaption>
</figure>
<h3 id="プロトコルのバージョン"><a href="#プロトコルのバージョン" class="anchor-link">プロトコルのバージョン</a></h3>
<figure id="fig-2">
  <a href="/static/images/2019/security/fig2.png">
    <img src="/static/images/2019/security/fig2.png" alt="図2. TLSプロトコルのバージョン使用状況" aria-labelledby="fig2-caption" aria-describedby="fig2-description" width="760" height="470" data-width="760" data-height="470" data-seamless="" data-frameborder="0" data-scrolling="no" data-iframe="https://docs.google.com/spreadsheets/d/e/2PACX-1vRCG3clMcnkVPrnZSCWFi3qG-EU00Qr8X3XaRFQPWHEXQmYWMxnS_kfmmyMQsPZe2P6ECjzCjG0dVFg/pubchart?oid=1441324762&amp;format=interactive" loading="lazy" />
  </a>
  <div id="fig2-description" class="visually-hidden">横棒グラフは、デスクトップとモバイルのTLSの使用状況を示しています。TLSv1.2が58%、TLSv1.3が41%、TLSv1.0の使用率はほとんどなく (0.75%)、TLSv1.1の使用率はわずかです。</div>
  <figcaption id="fig2-caption"><a href="#fig-2" class="anchor-link">図 2.</a> TLSプロトコルのバージョン使用状況</figcaption>
</figure>
<p>図2は、さまざまなプロトコルバージョンのサポートを示しています。TLSv1.0やTLSv1.1のようなレガシーなTLSバージョンの使用は最小限であり、ほとんどすべてのサポートはプロトコルの新しいバージョンであるTLSv1.2やTLSv1.3に対応しています。TLSv1.3はまだ標準としては非常に若いですが（TLSv1.3は<a href="https://tools.ietf.org/html/rfc8446">2018年8月</a>に正式に承認されたばかりです）、TLSを使用するリクエストの40％以上が最新バージョンを使用しています！　TLSv1.0やTLSv1.1のようなレガシーバージョンの使用はほとんどありません。</p>
<p>これは、多くのサイトが<a href="./third-parties">サードパーティコンテンツ</a>のために大きなプレイヤーからのリクエストを使用していることが原因であると考えられます。例えば、どのようなサイトでもGoogle Analytics、Google AdWords、またはGoogle FontsをロードしGoogleのような大規模なプレイヤーは通常新しいプロトコルのためのアーリーアダプターです。</p>
<p>ホームページだけを見て、それ以外のサイトのリクエストをすべて見ない場合、TLSの使用率は予想通りかなり高いですが、Wordpressのような<a href="./cms">CMS</a>サイトや<a href="./cdn">CDN</a>のようなサイトが原因である可能性は高いです。</p>
<figure id="fig-3">
  <a href="/static/images/2019/security/fig3.png">
    <img src="/static/images/2019/security/fig3.png" alt="図3. ホームページリクエストだけのTLSプロトコルバージョン使用状況。" aria-labelledby="fig3-caption" aria-describedby="fig3-description" width="760" height="470" data-width="760" data-height="470" data-seamless="" data-frameborder="0" data-scrolling="no" data-iframe="https://docs.google.com/spreadsheets/d/e/2PACX-1vRCG3clMcnkVPrnZSCWFi3qG-EU00Qr8X3XaRFQPWHEXQmYWMxnS_kfmmyMQsPZe2P6ECjzCjG0dVFg/pubchart?oid=897771966&amp;format=interactive" loading="lazy" />
  </a>
  <div id="fig3-description" class="visually-hidden">横棒グラフは、デスクトップとモバイルの類似したTLSの使用状況を示しています。デスクトップでは47%(モバイルでは43%)がTLSv1.2、デスクトップでは20.2%(モバイルでは19.7%)がTLSv1.3を使用しており、TLSv1.0の使用量はほとんどなく(1.1%～1.2%)、TLSv1.1の使用量はわずかです。</div>
  <figcaption id="fig3-caption"><a href="#fig-3" class="anchor-link">図 3.</a> ホームページリクエストだけのTLSプロトコルバージョン使用状況。</figcaption>
</figure>
<p>一方で、Web Almanacが使用している<a href="./methodology">方法論</a>は、大規模サイトの利用状況を<em>過小評価</em>します。なぜなら、大規模サイトはそのサイト自体が現実世界ではより大きなインターネット・トラフィックを形成している可能性が高いにもかかわらず、これらの統計のために一度しかクロールされないからです。</p>
<h3 id="証明書発行者"><a href="#証明書発行者" class="anchor-link">証明書発行者</a></h3>
<p>もちろん、ウェブサイトでHTTPSを使用するには、認証局（CA）からの証明書が必要です。HTTPSの使用の増加に伴い、CAとその製品／サービスの使用も増加しています。ここでは、証明書を使用するTLSリクエストの量に基づいて、上位10社の証明書発行者を紹介します。</p>
<figure id="fig-4">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>発行証明書発行局</th>
            <th>デスクトップ</th>
            <th>モバイル</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Google Internet Authority G3</td>
            <td>19.26%</td>
            <td>19.68%</td>
          </tr>
          <tr>
            <td>Let's Encrypt Authority X3</td>
            <td>10.20%</td>
            <td>9.19%</td>
          </tr>
          <tr>
            <td>DigiCert SHA2 High Assurance Server CA</td>
            <td>9.83%</td>
            <td>9.26%</td>
          </tr>
          <tr>
            <td>DigiCert SHA2 Secure Server CA</td>
            <td>7.55%</td>
            <td>8.72%</td>
          </tr>
          <tr>
            <td>GTS CA 1O1</td>
            <td>7.87%</td>
            <td>8.43%</td>
          </tr>
          <tr>
            <td>DigiCert SHA2 Secure Server CA</td>
            <td>7.55%</td>
            <td>8.72%</td>
          </tr>
          <tr>
            <td>COMODO RSA Domain Validation Secure Server CA</td>
            <td>6.29%</td>
            <td>5.79%</td>
          </tr>
          <tr>
            <td>Go Daddy Secure Certificate Authority - G2</td>
            <td>4.84%</td>
            <td>5.10%</td>
          </tr>
          <tr>
            <td>Amazon</td>
            <td>4.71%</td>
            <td>4.45%</td>
          </tr>
          <tr>
            <td>COMODO ECC Domain Validation Secure Server CA 2</td>
            <td>3.22%</td>
            <td>2.75%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <figcaption><a href="#fig-4" class="anchor-link">図 4.</a> 使用されている認証局トップ10。</figcaption>
</figure>
<p>前述したように、Googleのボリュームは他のサイトでGoogleアナリティクス、Google Adwords、またはGoogle Fontsを繰り返し使用していることを反映している可能性が高い。</p>
<p><a href="https://letsencrypt.org/ja/">Let's Encrypt</a>の台頭は2016年初頭の開始後、急成長を遂げ、それ以来世界でもトップレベルの証明書発行局の1つになりました。無料の証明書の可用性と自動化されたツールは、ウェブ上でのHTTPSの採用に決定的に重要な役割を果たしています。Let's Encryptは、これらの両方において重要な役割を果たしています。</p>
<p>コストの削減により、HTTPSへの参入障壁は取り除かれましたが、Let's Encryptが使用する自動化は証明書の寿命を短くできるため、長期的にはより重要であると思われます、<a href="https://scotthelme.co.uk/why-we-need-to-do-more-to-reduce-certificate-lifetimes/">これは多くのセキュリ ティ上のメリットがあります</a>。</p>
<h3 id="認証キーの種類"><a href="#認証キーの種類" class="anchor-link">認証キーの種類</a></h3>
<p>HTTPSを使用するという重要な要件と並行して、適切な構成を使用するという要件もあります。非常に多くの設定オプションと選択肢があるため、これは慎重にバランスを取る必要があります。</p>
<p>まず、認証に使用される鍵について見ていきましょう。従来、証明書はRSAアルゴリズムを使用した鍵に基づいて発行されてきましたが、より新しく優れたアルゴリズムであるECDSA(Elliptic Curve Digital Signature Algorithm — 楕円曲線DSA) を使用しており、RSAアルゴリズムよりも優れた性能を発揮する小さな鍵の使用を可能にしています。私たちのクロールの結果を見ると、ウェブの大部分がRSAを使用していることがわかります。</p>
<figure id="fig-5">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>キーの種類</th>
            <th>デスクトップ</th>
            <th>モバイル</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>RSA Keys</td>
            <td>48.67%</td>
            <td>58.8%</td>
          </tr>
          <tr>
            <td>ECDA Keys</td>
            <td>21.47%</td>
            <td>26.41%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <figcaption><a href="#fig-5" class="anchor-link">図 5.</a> 使用する認証キーの種類</figcaption>
</figure>
<p>ECDSA鍵はより強力な鍵であるため、より小さな鍵の使用が可能となりRSA鍵よりも優れたパフォーマンスを発揮しますが、下位互換性に関する懸念やその間の両方のサポートの複雑さが一部のウェブサイト運営者の移行を妨げる要因となっています。</p>
<h3 id="forward-secrecy"><a href="#forward-secrecy" class="anchor-link">Forward secrecy</a></h3>
<p><a href="https://ja.wikipedia.org/wiki/Forward_secrecy">Forward secrecy</a>は将来サーバの秘密鍵が漏洩した場合でも、サーバへの各接続が公開されるのを防ぐような方法で接続を保護するいくつかの鍵交換メカニズムの特性です。これは、接続のセキュリティを保護するために全てのTLS接続で望ましい事として、セキュリティコミュニティ内ではよく理解されています。2008年にTLSv1.2でオプション設定として導入され、2018年にはTLSv1.3でForward Secrecyの使用が必須となりました。</p>
<p>Forward Secrecyを提供するTLSリクエストの割合を見ると、サポートが非常に大きいことがわかります。デスクトップの96.92％、モバイルリクエストの96.49％がForward Secrecyを使用しています。TLSv1.3の採用が継続的に増加していることから、これらの数字はさらに増加すると予想されます。</p>
<h3 id="暗号スイート"><a href="#暗号スイート" class="anchor-link">暗号スイート</a></h3>
<p>TLSでは、さまざまな暗号スイートを使用できます。従来、TLSの新しいバージョンは暗号スイートを追加してきましたが、古い暗号スイートを削除することには消極的でした。TLSv1.3はこれを単純化するために、より少ない暗号スイートのセットを提供し、古い安全でない暗号スイートを使用することを許可しません。<a href="https://www.ssllabs.com/">SSL Labs</a> のようなツールは、ウェブサイトのTLS設定 (サポートされている暗号スイートとその好ましい順序を含む) を簡単に見ることができ、より良い設定を促進するのに役立ちます。TLSリクエストのためにネゴシエートされた暗号化スイートの大部分は確かに優れたものであったことがわかります。</p>
<figure id="fig-6">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>暗号スイート</th>
            <th>デスクトップ</th>
            <th>モバイル</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>AES_128_GCM</code></td>
            <td>75.87%</td>
            <td>76.71%</td>
          </tr>
          <tr>
            <td><code>AES_256_GCM</code></td>
            <td>19.73%</td>
            <td>18.49%</td>
          </tr>
          <tr>
            <td><code>AES_256_CBC</code></td>
            <td>2.22%</td>
            <td>2.26%</td>
          </tr>
          <tr>
            <td><code>AES_128_CBC</code></td>
            <td>1.43%</td>
            <td>1.72%</td>
          </tr>
          <tr>
            <td><code>CHACHA20_POLY1305</code></td>
            <td>0.69%</td>
            <td>0.79%</td>
          </tr>
          <tr>
            <td><code>3DES_EDE_CBC</code></td>
            <td>0.06%</td>
            <td>0.04%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <figcaption><a href="#fig-6" class="anchor-link">図 6.</a> 使用されている暗号スイートの使用法</figcaption>
</figure>
<p>古いCBC暗号は安全性が低いので、GCM暗号がこのように広く使われるようになったのはポジティブなことです。<a href="https://blog.cloudflare.com/it-takes-two-to-chacha-poly/">CHACHA20_POLY1305</a>はまだニッチな暗号スイートであり、私たちはまだ<a href="https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%AA%E3%83%97%E3%83%ABDES#%E5%AE%89%E5%85%A8%E6%80%A7">安全でないトリプルDES暗号</a>をごくわずかしか使っていません。</p>
<p>これらはChromeを使ったクロールに使われた暗号化スイートですが、サイトは古いブラウザでも他の暗号化スイートをサポートしている可能性が高いことに注意してください。例えば<a href="https://www.ssllabs.com/ssl-pulse/">SSL Pulse</a> などの他の情報源では、サポートされているすべての暗号スイートとプロトコルの範囲についてより詳細な情報を提供しています。</p>
<h2 id="混合コンテンツ"><a href="#混合コンテンツ" class="anchor-link">混合コンテンツ</a></h2>
<p>ウェブ上のほとんどのサイトは元々HTTPサイトとして存在しており、HTTPSにサイトを移行しなければなりませんでした。この「リフトアンドシフト」作業は難しく、時には見落としたり、取り残されたりすることもあります。その結果、ページはHTTPSで読み込まれているが、ページ上の何か（画像やスタイルなど）はHTTPで読み込まれているような、コンテンツが混在しているサイトが発生します。コンテンツが混在していると、セキュリティやプライバシーに悪影響を及ぼし、発見して修正するのが困難になることがあります。</p>
<figure id="fig-7">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>混合コンテンツタイプ</th>
            <th>デスクトップ</th>
            <th>モバイル</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>任意のコンテンツが混在しているページ</td>
            <td>16.27%</td>
            <td>15.37%</td>
          </tr>
          <tr>
            <td>アクティブな混合コンテンツのページ</td>
            <td>3.99%</td>
            <td>4.13%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <figcaption><a href="#fig-7" class="anchor-link">図 7.</a> 混在コンテンツの利用状況。</figcaption>
</figure>
<p>モバイル（645,485サイト）とデスクトップ（594,072サイト）では、約20％のサイトが何らかの形で混合コンテンツを表示していることがわかります。画像のようなパッシブな混合コンテンツの危険性は低いですが、混合コンテンツを持つサイトのほぼ4分の1がアクティブな混合コンテンツを持っていることがわかります。JavaScriptのようなアクティブな混合コンテンツは、攻撃者が自分の敵対的なコードを簡単にページに挿入できるため、より危険です。</p>
<p>これまでのウェブブラウザは、受動的な混合コンテンツを許可して警告を表示していたが、能動的な混合コンテンツはブロックしていた。しかし最近では、Chrome<a href="https://blog.chromium.org/2019/10/no-more-mixed-messages-about-https.html">発表</a> はこの点を改善し、HTTPSが標準になるにつれて代わりにすべての混合コンテンツをブロックすることを意図しています。</p>
<h2 id="セキュリティヘッダ"><a href="#セキュリティヘッダ" class="anchor-link">セキュリティヘッダ</a></h2>
<p>サイト運営者がユーザーをより良く保護するための多くの新しい機能が、ブラウザに組み込まれたセキュリティ保護を設定したり制御したりできる新しいHTTPレスポンスヘッダの形で提供されています。これらの機能の中には、簡単に有効にして大きなレベルの保護を提供するものもあれば、サイト運営者が少し作業を必要とするものもあります。サイトがこれらのヘッダを使用しており、正しく設定されているかどうかを確認したい場合は、<a href="https://securityheaders.com/">Security Headers</a>ツールを使用してスキャンできます。</p>
<figure id="fig-8">
  <a href="/static/images/2019/security/fig8.png">
    <img src="/static/images/2019/security/fig8.png" alt="図8. セキュリティヘッダの使用法" aria-labelledby="fig8-caption" aria-describedby="fig8-description" width="760" height="450" data-width="760" data-height="450" data-seamless="" data-frameborder="0" data-scrolling="no" data-iframe="https://docs.google.com/spreadsheets/d/e/2PACX-1vRCG3clMcnkVPrnZSCWFi3qG-EU00Qr8X3XaRFQPWHEXQmYWMxnS_kfmmyMQsPZe2P6ECjzCjG0dVFg/pubchart?oid=2029255231&amp;format=interactive" loading="lazy" />
  </a>
  <div id="fig8-description" class="visually-hidden">デスクトップ、モバイルともに、左から順にセキュリティヘッダリストの使用量が増加していることを縦棒グラフで示しています。左から順に、Cross-origin-resource-policy(両方とも0サイト)、feature policy(デスクトップとモバイルで約8k)、report-to(デスクトップで74k、モバイルで83k)、nel(デスクトップで74k、モバイルで83k)、referrer-policy(デスクトップで142k、モバイルで156k)、content-security-policy(デスクトップで240k)のリストです。252k モバイル）、strict-transport-security（648k デスクトップ、679k モバイル）、x-xss-protection（642k デスクトップ、805k モバイル）、x-frame-options（743k デスクトップ、782k モバイル）、そして最後にx-content-type-options（770k デスクトップ、932k モバイル）です。</div>
  <figcaption id="fig8-caption"><a href="#fig-8" class="anchor-link">図 8.</a> セキュリティヘッダの使用法</figcaption>
</figure>
<h3 id="http-strict-transport-security"><a href="#http-strict-transport-security" class="anchor-link">HTTP Strict Transport Security</a></h3>
<p><a href="https://tools.ietf.org/html/rfc6797">HSTS</a> ヘッダーは、Webサイトがブラウザに、安全なHTTPS接続でのみサイトと通信するように指示することを可能にします。これは、http:// URLを使用しようとする試みは、リクエストが行われる前に自動的にhttps://に変換されることを意味します。リクエストの40％以上がTLSを使用できることを考えると、要求するようにブラウザに指示しているリクエストの割合はかなり低いと考えられます。</p>
<figure id="fig-9">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>HSTSディレクティブ</th>
            <th>デスクトップ</th>
            <th>モバイル</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>max-age</code></td>
            <td>14.80%</td>
            <td>12.81%</td>
          </tr>
          <tr>
            <td><code>includeSubDomains</code></td>
            <td>3.86%</td>
            <td>3.29%</td>
          </tr>
          <tr>
            <td><code>preload</code></td>
            <td>2.27%</td>
            <td>1.99%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <figcaption><a href="#fig-9" class="anchor-link">図 9.</a> HSTS ディレクティブの使用法</figcaption>
</figure>
<p>モバイルページやデスクトップページの15％未満が<code>max-age</code>ディレクティブ付きのHSTSを発行しています。これは有効なポリシーの最低条件です。また、<code>includeSubDomains</code>ディレクティブでサブドメインをポリシーに含めているページはさらに少なく、HSTSのプリロードを行っているページはさらに少ないです。HSTSの<code>max-age</code>の中央値を見ると、これを使用している場合はデスクトップとモバイルの両方で15768000となっており、半年(60X60X24X365/2)に相当する強力な設定であることがわかります。</p>
<figure id="fig-10">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <tbody>
          <tr>
            <td></td>
            <th scope="colgroup" colspan="2">クライアント</th>
          </tr>
          <tr>
            <th scope="col">パーセンタイル</th>
            <th scope="col">デスクトップ</th>
            <th scope="col">モバイル</th>
          </tr>
          <tr>
            <td>10</td>
            <td>300</td>
            <td>300</td>
          </tr>
          <tr>
            <td>25</td>
            <td>7889238</td>
            <td>7889238</td>
          </tr>
          <tr>
            <td>50</td>
            <td>15768000</td>
            <td>15768000</td>
          </tr>
          <tr>
            <td>75</td>
            <td>31536000</td>
            <td>31536000</td>
          </tr>
          <tr>
            <td>90</td>
            <td>63072000</td>
            <td>63072000</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <figcaption><a href="#fig-10" class="anchor-link">図 10.</a> HSTSの`max-age`ポリシーのパーセンタイル別の中値。</figcaption>
</figure>
<h4 id="hstsプリロード"><a href="#hstsプリロード" class="anchor-link">HSTSプリロード</a></h4>
<p>HTTPレスポンスヘッダーを介して配信されるHSTSポリシーでは、初めてサイトを訪れたときに、ブラウザはポリシーが設定されているかどうかを知ることができません。この<a href="https://en.wikipedia.org/wiki/Trust_on_first_use">初回使用時の信頼</a>の問題を回避するために、サイト運営者はブラウザ(または他のユーザーエージェント)にポリシーをプリロードしておくことができます。</p>
<p>プリロードにはいくつかの要件があり、<a href="https://hstspreload.org/">HSTSプリロード</a>サイトで概要が説明されています。現在の基準では、デスクトップでは0.31％、モバイルでは0.26％というごく少数のサイトしか対象としていないことがわかる。サイトは、ドメインをプリロードするために送信する前、ドメインの下にあるすべてのサイトをHTTPSに完全に移行させておく必要があります。</p>
<h3 id="コンテンツセキュリティポリシー"><a href="#コンテンツセキュリティポリシー" class="anchor-link">コンテンツセキュリティポリシー</a></h3>
<p>ウェブアプリケーションは、敵対的なコンテンツがページへ挿入される攻撃に頻繁に直面しています。最も心配なコンテンツはJavaScriptであり、攻撃者がJavaScriptをページに挿入する方法を見つけると、有害な攻撃を実行できます。これらの攻撃は<a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0">クロスサイトスクリプティング(XSS)</a>として知られており、<a href="https://www.w3.org/TR/CSP2/">コンテンツセキュリティポリシー(CSP)</a> はこれらの攻撃に対する効果的な防御策を提供しています。</p>
<p>CSPとは、ウェブサイトが公開しているHTTPヘッダ(<code>Content-Security-Policy</code>)のことで、サイトで許可されているコンテンツに関するルールをブラウザに伝えるものです。セキュリティ上の欠陥のために追加のコンテンツがサイトに注入され、それがポリシーで許可されていない場合、ブラウザはそのコンテンツの使用をブロックします。XSS保護の他にも、CSPは、<a href="#upgrade-insecure-requests">HTTPSへの移行を容易にする</a>など、いくつかの重要な利点を提供しています。</p>
<p>CSPの多くの利点にもかかわらず、その非常に目的がページ上で許容されるものを制限することであるため、ウェブサイトに実装することは複雑になる可能性があります。ポリシーは必要なすべてのコンテンツやリソースを許可しなければならず、大きく複雑になりがちです。<a href="https://report-uri.com/">レポートURI</a>のようなツールは、適切なポリシーを分析して構築するのに役立ちます。</p>
<p>デスクトップページのわずか5.51％にCSPが含まれ、モバイルページのわずか4.73％にCSPが含まれていることがわかりましたが、これは展開の複雑さが原因と思われます。</p>
<h4 id="ハッシュノンス"><a href="#ハッシュノンス" class="anchor-link">ハッシュ/ノンス</a></h4>
<p>CSPの一般的なアプローチは、JavaScriptなどのコンテンツをページにロードすることを許可されているサードパーティドメインのホワイトリストを作成することです。これらのホワイトリストの作成と管理は困難な場合があるため、<a href="https://www.w3.org/TR/CSP2/#source-list-valid-hashes">ハッシュ</a>と<a href="https://www.w3.org/TR/CSP2/#source-list-valid-nonces">ノンス</a>が代替的なアプローチとして導入されました。ハッシュはスクリプトの内容に基づいて計算されるので、ウェブサイト運営者が公開しているスクリプトが変更されたり、別のスクリプトが追加されたりするとハッシュと一致せずブロックされてしまいます。ノンスは、CSPによって許可され、スクリプトにタグが付けられているワンタイムコード(ページが読み込まれるたびに変更され推測されるのを防ぐ必要があります)です。このページのノンスの例は、ソースを見てGoogle Tag Managerがどのように読み込まれているかを見ることで見ることができます。</p>
<p>調査対象となったサイトのうち、ノンスソースを使用しているのはデスクトップページで0.09％、ハッシュソースを使用しているのはデスクトップページで0.02％にとどまっている。モバイルページではノンスソースを使用しているサイトは0.13%とやや多いが、ハッシュソースの使用率は0.01%とモバイルページの方が低い。</p>
<h4 id="strict-dynamic">
  <a href="#strict-dynamic" class="anchor-link"><code>strict-dynamic</code></a>
</h4>
<p>
  <a href="https://www.w3.org/TR/CSP3/">CSP</a>の次のイテレーションにおける<a href="https://www.w3.org/TR/CSP3/#strict-dynamic-usage"><code>strict-dynamic</code></a
  >の提案は、ホワイトリスト化されたスクリプトがさらにスクリプトの依存性をロードできるようにすることで、CSPを使用するためのサイト運営者の負担をさらに軽減します。すでに<a href="https://caniuse.com/#feat=mdn-http_headers_csp_content-security-policy_strict-dynamic">いくつかの最新ブラウザでサポート</a>されているこの機能の導入にもかかわらず、ポリシーにこの機能を含めるのは、デスクトップページの0.03％とモバイルページの0.1％にすぎません。
</p>
<h4 id="trusted-types">
  <a href="#trusted-types" class="anchor-link"><code>trusted-types</code></a>
</h4>
<p>XSS攻撃には様々な形がありますが、<a href="https://github.com/w3c/webappsec-trusted-types">Trusted-Types</a>はDOM-XSSに特化して作られました。効果的なメカニズムであるにもかかわらず、私たちのデータによると、モバイルとデスクトップの2つのページだけがTrusted-Typesディレクティブを使用しています。</p>
<h4 id="unsafe-inlineとunsafe-eval">
  <a href="#unsafe-inlineとunsafe-eval" class="anchor-link"><code>unsafe inline</code>と<code>unsafe-eval</code></a>
</h4>
<p>CSPがページにデプロイされると、インラインスクリプトや<code>eval()</code>の使用のような特定の安全でない機能は無効化されます。ページはこれらの機能に依存し、安全な方法で、おそらくノンスやハッシュソースを使ってこれらの機能を有効にできます。サイト運営者は、<code>unsafe-inline</code>や<code>unsafe-eval</code>を使って、これらの安全でない機能をCSPで再有効にすることもできますが、その名前が示すようにそうすることでCSPが提供する保護の多くを失うことになります。CSPを含むデスクトップページの5.51％のうち、33.94％が<code>unsafe-inline</code>を、31.03％が<code>unsafe-eval</code>を含んでいます。モバイルページでは、CSPを含む4.73％のうち、34.04％が<code>unsafe-inline</code>を使用し、31.71％が<code>unsafe-eval</code>を使用していることがわかります。</p>
<h4 id="upgrade-insecure-requests">
  <a href="#upgrade-insecure-requests" class="anchor-link"><code>upgrade-insecure-requests</code></a>
</h4>
<p>先に、サイト運営者がHTTPからHTTPSへの移行で直面する共通の問題として、一部のコンテンツがHTTPSページのHTTP上に誤って読み込まれてしまう可能性があることを述べました。この問題は混合コンテンツとして知られており、CSPはこの問題を解決する効果的な方法を提供します。upgrade-insecure-requests`ディレクティブは、ブラウザにページ上のすべてのサブリソースを安全な接続で読み込むように指示し、例としてHTTPリクエストをHTTPSリクエストに自動的にアップグレードします。ページ上のサブリソースのためのHSTSのようなものと考えてください。</p>
<p>先に図7で示したように、デスクトップで調査したHTTPSページのうち、16.27％のページが混合コンテンツを読み込んでおり、3.99％のページがJS/CSS/fontsなどのアクティブな混合コンテンツを読み込んでいることがわかる。モバイルページでは、HTTPSページの15.37％が混合コンテンツを読み込み、4.13％がアクティブな混合コンテンツを読み込みました。HTTP上でJavaScriptなどのアクティブなコンテンツを読み込むことで、攻撃者は簡単に敵対的なコードをページに注入して攻撃を開始できます。これは、CSPの<code>upgrade-insecure-requests</code> ディレクティブが防御しているものです。</p>
<p><code>upgrade-insecure-requests</code>ディレクティブは、デスクトップページの3.24％とモバイルページの2.84％のCSPに含まれており、採用が増えることで大きな利益が得られることを示しています。以下のようなポリシーで、幅広いカテゴリをホワイトリスト化し、<code>unsafe-inline</code>や<code>unsafe-eval</code>を含めることで、完全にロックダウンされたCSPや複雑さを必要とせずに比較的簡単に導入できます。</p>
<pre><code>Content-Security-Policy: upgrade-insecure-requests; default-src https:</code></pre>
<h4 id="frame-ancestors">
  <a href="#frame-ancestors" class="anchor-link"><code>frame-ancestors</code></a>
</h4>
<p><a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AA%E3%83%83%E3%82%AF%E3%82%B8%E3%83%A3%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0">クリックジャッキング</a>として知られているもう1つの一般的な攻撃は、敵対するウェブサイトのiframeの中にターゲットのウェブサイトを配置し、自分たちがコントロールしている隠しコントロールやボタンをオーバーレイする攻撃者によって行われます。<code>X-Frame-Options</code>ヘッダー(後述)はもともとフレームを制御することを目的としていましたが、柔軟性がなく、CSPの<code>frame-ancestors</code>はより柔軟なソリューションを提供するために介入しました。サイト運営者は、フレーム化を許可するホストのリストを指定できるようになり、他のホストがフレーム化しようとするのを防ぐことができるようになりました。</p>
<p>調査したページのうち、デスクトップページの2.85％がCSPで<code>frame-ancestors</code>ディレクティブを使用しており、デスクトップページの0.74％がframe-Ancestorsを<code>'none'</code>に設定してフレーミングを禁止し、0.47％のページが<code>frame-ancestors</code>を<code>'self'</code>に設定して自分のサイトのみがフレーミングできるようにしています。モバイルでは2.52％のページが<code>frame-ancestors</code>を使用しており、0.71％が<code>'none'</code>を設定し、0.41％が<code>self'</code>を設定しています。</p>
<h3 id="参照元ポリシー"><a href="#参照元ポリシー" class="anchor-link">参照元ポリシー</a></h3>
<p>
  <a href="https://www.w3.org/TR/referrer-policy/"><code>Referrer-Policy</code></a
  >ヘッダーは、ユーザーが現在のページから離れた場所へ移動したとき、<code>Refererer</code>ヘッダーにどのような情報を送るかをサイトが制御することを可能とします。これは、検索クエリやURLパラメータに含まれるその他のユーザー依存情報など、URLに機密データが含まれている場合、情報漏洩の原因となる可能性があります。<code>Referer</code>ヘッダで送信される情報を制御し、理想的には制限することで、サイトはサードパーティに送信される情報を減らすことで訪問者のプライバシーを保護できます。
</p>
<p>リファラーポリシーは<code>Refererer</code>ヘッダのスペルミス<a href="https://stackoverflow.com/questions/3087626/was-the-misspelling-of-the-http-field-name-referer-intentional">これはよく知られたエラーとなっています</a>に従っていないことに注意してください。</p>
<p>デスクトップページの3.25％とモバイルページの2.95%が<code>Referrerer-Policy</code>ヘッダを発行しています。</p>
<figure id="fig-11">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>設定</th>
            <th>デスクトップ</th>
            <th>モバイル</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>no-referrer-when-downgrade</code></td>
            <td>39.16%</td>
            <td>41.52%</td>
          </tr>
          <tr>
            <td><code>strict-origin-when-cross-origin</code></td>
            <td>39.16%</td>
            <td>22.17%</td>
          </tr>
          <tr>
            <td><code>unsafe-url</code></td>
            <td>22.17%</td>
            <td>22.17%</td>
          </tr>
          <tr>
            <td><code>same-origin</code></td>
            <td>7.97%</td>
            <td>7.97%</td>
          </tr>
          <tr>
            <td><code>origin-when-cross-origin</code></td>
            <td>6.76%</td>
            <td>6.44%</td>
          </tr>
          <tr>
            <td><code>no-referrer</code></td>
            <td>5.65%</td>
            <td>5.38%</td>
          </tr>
          <tr>
            <td><code>strict-origin</code></td>
            <td>4.35%</td>
            <td>4.14%</td>
          </tr>
          <tr>
            <td><code>origin</code></td>
            <td>3.63%</td>
            <td>3.23%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <p>
    <figcapti on="">図11. <code>Referrer-Policy</code> 設定オプションの使用法。</figcapti>
  </p>
</figure>
<p>この表はページによって設定された有効な値を示しており、このヘッダーを使用するページのうち、デスクトップでは99.75％、モバイルでは96.55％のページが有効なポリシーを設定していることがわかる。最も人気のある設定は<code>no-referrer-when-downgrade</code>で、これはユーザがHTTPSページからHTTPページに移動する際<code>Refererer</code>ヘッダが送信されないようにするものです。2番目に人気のある選択は<code>strict-origin-when-cross-origin</code>で、これはスキームのダウングレード(HTTPSからHTTPナビゲーション)時に情報が送信されるのを防ぎ、<code>Refererer</code>で情報が送信される際にはソースのオリジンのみを含み、完全なURLは含まれません(例えば、<code>https://www.example.com/page/</code>ではなく<code>https://www.example.com</code>)。その他の有効な設定の詳細は、<a href="https://www.w3.org/TR/referrer-policy/#referrer-policies">Referrerer Policy specification</a>に記載されています、<code>unsafe-url</code>の多用はさらなる調査を必要としますが、アナリティクスや広告ライブラリのような<a href="./third-parties">サードパーティ</a>コンポーネントである可能性が高いです。</p>
<h3 id="機能方針"><a href="#機能方針" class="anchor-link">機能方針</a></h3>
<p>
  ウェブプラットフォームがより強力で機能も豊富になるにつれ、攻撃者はこれらの新しいAPIを興味深い方法で悪用できるようになります。強力なAPIの悪用を制限するために、サイト運営者は<a href="https://w3c.github.io/webappsec-feature-policy/"><code>Feature-Policy</code></a
  >ヘッダを発行して必要のない機能を無効化し、悪用されるのを防ぐことができます。
</p>
<p>ここでは、機能方針で管理されている人気の高い5つの機能をご紹介します。</p>
<figure id="fig-12">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>機能</th>
            <th>デスクトップ</th>
            <th>モバイル</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>microphone</code></td>
            <td>10.78%</td>
            <td>10.98%</td>
          </tr>
          <tr>
            <td><code>camera</code></td>
            <td>9.95%</td>
            <td>10.19%</td>
          </tr>
          <tr>
            <td><code>payment</code></td>
            <td>9.54%</td>
            <td>9.54%</td>
          </tr>
          <tr>
            <td><code>geolocation</code></td>
            <td>9.38%</td>
            <td>9.41%</td>
          </tr>
          <tr>
            <td><code>gyroscope</code></td>
            <td>7.92%</td>
            <td>7.90%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <figcaption><a href="#fig-12" class="anchor-link">図 12.</a> 使用される <code>Feature-Policy</code> オプションの上位5つ。</figcaption>
</figure>
<p>コントロールできる最も人気のある機能はマイクで、デスクトップとモバイルページのほぼ11％がマイクを含むポリシーを発行していることがわかります。データを掘り下げていくと、これらのページが何を許可しているか、またはブロックしているかを見ることができます。</p>
<figure id="fig-13">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>機能</th>
            <th>設定</th>
            <th>使用率</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>microphone</code></td>
            <td><code>none</code></td>
            <td>9.09%</td>
          </tr>
          <tr>
            <td><code>microphone</code></td>
            <td><code>none</code></td>
            <td>8.97%</td>
          </tr>
          <tr>
            <td><code>microphone</code></td>
            <td><code>self</code></td>
            <td>0.86%</td>
          </tr>
          <tr>
            <td><code>microphone</code></td>
            <td><code>self</code></td>
            <td>0.85%</td>
          </tr>
          <tr>
            <td><code>microphone</code></td>
            <td><code>*</code></td>
            <td>0.64%</td>
          </tr>
          <tr>
            <td><code>microphone</code></td>
            <td><code>*</code></td>
            <td>0.53%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <figcaption><a href="#fig-13" class="anchor-link">図 13.</a> マイク機能の設定.</figcaption>
</figure>
<p>圧倒的に最も一般的なアプローチは、ここではそのアプローチを取っているページの約9％で、完全にマイクの使用をブロックすることです。少数のページでは、独自のオリジンによるマイクの使用を許可しており、興味深いことにページ内のコンテンツを読み込んでいる任意のオリジンによるマイクの使用を意図的に許可しているページの少数選択があります。</p>
<h3 id="x-frame-options">
  <a href="#x-frame-options" class="anchor-link"><code>X-Frame-Options</code></a>
</h3>
<p>
  <a href="https://tools.ietf.org/html/rfc7034"><code>X-Frame-Options</code></a
  >ヘッダーは、ページが別のページでiframeに配置できるかどうかを制御することを可能にします。上述したCSPの<code>frame-ancestors</code>の柔軟性には欠けますが、フレームの細かい制御を必要としない場合には効果的です。
</p>
<p>デスクトップ(16.99％)とモバイル(14.77％)の両方で<code>X-Frame-Options</code>ヘッダの使用率が非常に高いことがわかります。</p>
<figure id="fig-14">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>設定</th>
            <th>デスクトップ</th>
            <th>モバイル</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>sameorigin</code></td>
            <td>84.92%</td>
            <td>83.86%</td>
          </tr>
          <tr>
            <td><code>deny</code></td>
            <td>13.54%</td>
            <td>14.50%</td>
          </tr>
          <tr>
            <td><code>allow-from</code></td>
            <td>1.53%</td>
            <td>1.64%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <figcaption><a href="#fig-14" class="anchor-link">図 14.</a> 使用される <code>X-Frame-Options</code> の設定。</figcaption>
</figure>
<p>大多数のページでは、そのページのオリジンのみにフレーミングを制限しているようで、次の重要なアプローチはフレーミングを完全に防止することです。これはCSPの<code>frame-ancestors</code>と似ており、これら2つのアプローチが最も一般的です。また、<code>allow-from</code>オプションは、理論的にはサイト所有者がフレーム化を許可するサードパーティのドメインをリストアップできるようにするものですが、<a href="https://developer.mozilla.org/ja/docs/Web/HTTP/X-Frame-Options#Browser_compatibility">決して十分にサポートされていないので</a>、非推奨とされています。</p>
<h3 id="x-content-type-options">
  <a href="#x-content-type-options" class="anchor-link"><code>X-Content-Type-Options</code></a>
</h3>
<p>
  <a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/X-Content-Type-Options"><code>X-Content-Type-Options</code></a
  >ヘッダは最も広く展開されているセキュリティヘッダであり、最もシンプルであり、設定可能な値は<code>nosniff</code>のみです。このヘッダが発行されると、ブラウザはコンテンツの一部を<code>Content-Type</code>ヘッダで宣言されたMIMEタイプとして扱わなければならず、ファイルが異なるタイプのものであることを示唆したときに値を変更しようとはしません。ブラウザが誤ってタイプを嗅ぎ取るように説得された場合、さまざまなセキュリティ上の欠陥が導入される可能性となります。
</p>
<p>モバイルとデスクトップの両方で、17.61％のページが<code>X-Content-Type-Options</code>ヘッダを発行していることがわかりました。</p>
<h3 id="x-xss-protection">
  <a href="#x-xss-protection" class="anchor-link"><code>X-XSS-Protection</code></a>
</h3>
<p><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/X-XSS-Protection">X-XSS-Protection`</a>ヘッダーは、サイトがブラウザに組み込まれたXSS AuditorやXSS Filterを制御することを可能にし、理論的には何らかのXSS保護を提供するはずです。</p>
<p>デスクトップリクエストの14.69％とモバイルリクエストの15.2％が<code>X-XSS-Protection</code>ヘッダを使用していた。データを掘り下げてみると、ほとんどのサイト運営者がどのような意図を持っているかが図13に示されています。</p>
<figure id="fig-15">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>設定</th>
            <th>デスクトップ</th>
            <th>モバイル</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>1;mode=block</code></td>
            <td>91.77%</td>
            <td>91.46%</td>
          </tr>
          <tr>
            <td><code>1</code></td>
            <td>5.54%</td>
            <td>5.35%</td>
          </tr>
          <tr>
            <td><code>0</code></td>
            <td>2.58%</td>
            <td>3.11%</td>
          </tr>
          <tr>
            <td><code>1;report=</code></td>
            <td>0.12%</td>
            <td>0.09%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <figcaption><a href="#fig-15" class="anchor-link">図 15.</a> <code>X-XSS-Protection</code> の利用設定。</figcaption>
</figure>
<p>値<code>1</code>はフィルタ/監査を有効にし、<code>mode=block</code>は(理論的には)XSS攻撃が疑われる場合にページを表示しないような最も強い保護を設定します。2番目に多かった設定は、単に監査/フィルタがオンになっていることを確認するために<code>1</code>という値を提示したもので、3番目に多かった設定は非常に興味深いものでした。</p>
<p>ヘッダーに<code>0</code>の値を設定すると、ブラウザが持っている可能性のあるXSSの監査やフィルタを無効にするように指示します。歴史的な攻撃の中には監査やフィルタがユーザーを保護するのではなく、攻撃者を助けるように騙されてしまうことが実証されているものもあるのでサイト運営者の中には、XSSに対する十分な保護があると確信している場合にそれを無効にできるものもあります。</p>
<p>これらの攻撃のため、EdgeはXSSフィルタを引退させ、ChromeはXSS監査を非推奨とし、Firefoxはこの機能のサポートを実装しませんでした。現在ではほとんど役に立たなくなっているにもかかわらず、現在でも全サイトの約15％でヘッダーが広く使われています。</p>
<h3 id="report-to"><a href="#report-to" class="anchor-link">Report-To</a></h3>
<p><a href="https://www.w3.org/TR/reporting/">Reporting API</a> は、サイト運営者が<a href="https://scotthelme.co.uk/introducing-the-reporting-api-nel-other-major-changes-to-report-uri/">ブラウザからの遠隔測定</a>の様々な情報を収集できるようにするため導入されました。サイト上の多くのエラーや問題は、ユーザーの体験を低下させる可能性がありますが、サイト運営者はユーザーが連絡しなければ知ることができません。Reporting APIは、ユーザーの操作や中断なしに、ブラウザがこれらの問題を自動的に報告するメカニズムを提供します。Reporting APIは<code>Report-To</code>ヘッダーを提供することで設定されます。</p>
<p>遠隔測定を送信すべき場所を含むヘッダーを指定することでブラウザは自動的にデータの送信を開始し、<a href="https://report-uri.com/">Report URI</a>のようなサードパーティのサービスを使用してレポートを収集したり、自分で収集したりできます。導入と設定の容易さを考えると、現在この機能を有効にしているサイトは、デスクトップ（1.70％）とモバイル（1.57％）のごく一部に過ぎないことがわかります。収集できるテレメトリの種類については、<a href="https://www.w3.org/TR/reporting/">Reporting API仕様</a>を参照してください。</p>
<h3 id="ネットワークエラーロギング"><a href="#ネットワークエラーロギング" class="anchor-link">ネットワークエラーロギング</a></h3>
<p><a href="https://www.w3.org/TR/network-error-logging/">ネットワークエラーロギング(NEL)</a>は、サイトが動作不能になる可能性のあるブラウザのさまざまな障害についての詳細な情報を提供します。<code>Report-To</code>が読み込まれたページの問題を報告するために使用されるのに対し、<code>NEL</code>ヘッダーを使用すると、サイトはブラウザにこのポリシーをキャッシュするように通知し、将来の接続問題が発生したときに上記の<code>Reporting-To</code>ヘッダーで設定されたエンドポイントを介して報告できます。したがって、NELはReporting APIの拡張機能とみなすことができます。</p>
<p>もちろん、NELはReporting APIに依存しているので、NELの使用量がReporting APIの使用量を上回ることはありません。これらの数値が同じであるという事実は、これらが一緒にデプロイされていることを示唆しています。</p>
<p>NELは信じられないほど貴重な情報を提供しており、情報の種類については<a href="https://w3c.github.io/network-error-logging/#predefined-network-error-types">ネットワークエラーロギング仕様</a>で詳しく説明しています。</p>
<h3 id="クリアサイトデータ"><a href="#クリアサイトデータ" class="anchor-link">クリアサイトデータ</a></h3>
<p>クッキー、キャッシュ、ローカルストレージなどを介してユーザーのデバイスにデータをローカルに保存する機能が増えているため、サイト運営者はこのデータを管理する信頼性の高い方法を必要としていました。Clear Site Dataヘッダーは、特定のタイプのすべてのデータがデバイスから削除されることを確実にする手段を提供しますが、<a href="https://caniuse.com/#feat=mdn-http_headers_clear-site-data">すべてのブラウザではまだサポートされていません</a>。</p>
<p>このヘッダの性質を考えると、使用量がほとんど報告されていないのは驚くに値しません。デスクトップリクエストが9件、モバイルリクエストが7件だけです。私たちのデータはサイトのホームページしか見ていないので、ログアウトのエンドポイントでヘッダーが最もよく使われているのを見ることはないでしょう。サイトからログアウトすると、サイト運営者はClear Site Dataヘッダを返し、ブラウザは指定されたタイプのすべてのデータを削除します。これはサイトのホームページでは行われないでしょう。</p>
<h2 id="クッキー"><a href="#クッキー" class="anchor-link">クッキー</a></h2>
<p>クッキーには利用可能な多くのセキュリティ保護があり、それらのいくつかは長年にわたって利用可能であるが、それらのいくつかは本当に非常に新しいものでありここ数年の間に導入されただけです。</p>
<h3 id="secure">
  <a href="#secure" class="anchor-link"><code>Secure</code></a>
</h3>
<p>クッキーの<code>Secure</code>フラグは、ブラウザに安全な(HTTPS)接続でのみクッキーを送信するように指示し、ホームページでセキュアフラグが設定されたクッキーを発行しているサイトはごくわずかな割合(デスクトップでは4.22％、モバイルでは3.68％)であることがわかります。この機能が比較的簡単に使用できることを考えると、これは憂慮すべきことです。繰り返しになりますが、HTTPとHTTPSの両方でデータを収集したいと考えている分析や広告<a href="./third-parties">サードパーティ</a>リクエストの高い使用率がこれらの数字を歪めている可能性が高く、認証クッキーのような他のクッキーでの使用状況を見るのは興味深い調査でしょう。</p>
<h3 id="httponly">
  <a href="#httponly" class="anchor-link"><code>HttpOnly</code></a>
</h3>
<p>クッキーの<code>HttpOnly</code>フラグはブラウザにページ上のJavaScriptがクッキーへアクセスできなくすることを指示します。多くのクッキーはサーバによってのみ使用されるので、ページ上のJavaScriptが必要としないため、クッキーへのアクセスを制限することはクッキーを盗むXSS攻撃からの大きな防御となります。デスクトップでは24.24％、モバイルでは22.23％と、ホームページ上でこのフラグを立ててクッキーを発行しているサイトの方がはるかに多いことがわかります。</p>
<h3 id="samesite">
  <a href="#samesite" class="anchor-link"><code>SameSite</code></a>
</h3>
<p>クッキーの保護に追加された最近の追加機能として、<code>SameSite</code>フラグは <a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA">クロスサイトリクエストフォージェリ(CSRF)</a>攻撃(XSRFとしてもよく知られています)に対する強力な保護となります。</p>
<p>これらの攻撃は、ブラウザが通常、すべてのリクエストに関連するクッキーを含むという事実を利用して動作します。したがって、ログインしていてクッキーが設定されていて、悪意のあるサイトを訪問した場合、APIを呼び出すことができブラウザは「親切に」クッキーを送信します。クッキーに<code>SameSite</code>属性を追加することで、第三者のサイトからの呼び出しがあった場合にクッキーを送信しないようにウェブサイトがブラウザに通知し、攻撃を失敗させることができます。</p>
<p>最近導入されたメカニズムなので、デスクトップとモバイルの両方でリクエストの0.1％と予想されるように、同じサイトのクッキーの使用率ははるかに低くなっています。クッキーがクロスサイトで送信されるべき使用例があります。例えば、シングルサインオンサイトは認証トークンと一緒にクッキーを設定することで暗黙のうちに動作します。</p>
<figure id="fig-16">
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <thead>
          <tr>
            <th>設定</th>
            <th>デスクトップ</th>
            <th>モバイル</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>strict</code></td>
            <td>53.14%</td>
            <td>50.64%</td>
          </tr>
          <tr>
            <td><code>lax</code></td>
            <td>45.85%</td>
            <td>47.42%</td>
          </tr>
          <tr>
            <td><code>none</code></td>
            <td>0.51%</td>
            <td>0.41%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <figcaption><a href="#fig-16" class="anchor-link">図 16.</a> SameSite設定の使用法。</figcaption>
</figure>
<p>既にSame-Siteのクッキーを利用しているページのうち、半分以上が<code>strict</code>モードで利用していることがわかる。これに続いて、<code>lax</code>モードでSame-Siteを利用しているサイト、そして少数のサイトでは<code>none</code>を利用しているサイトが続いています。この最後の値は、ブラウザベンダーが<code>lax</code>モードをデフォルトで実装する可能性があるという今後の変更をオプトアウトするために使用されます。</p>
<p>この機能は危険な攻撃からの保護を提供するため、現在のところ、主要なブラウザが <a href="https://blog.chromium.org/2019/10/developers-get-ready-for-new.html">デフォルトでこの機能を実装</a>し、値が設定されていなくてもクッキーに対してこの機能を有効にする可能性があると指摘されています。これが実現した場合、SameSiteの保護機能は有効になりますが、<code>strict</code>モードではなく<code>lax</code>モードの弱い設定では、より多くの破損を引き起こす可能性があるためです。</p>
<h3 id="プレフィックス"><a href="#プレフィックス" class="anchor-link">プレフィックス</a></h3>
<p>クッキーに最近追加されたもう一つの方法として、クッキープレフィックスがあります。これらはクッキーの名前を使用して、すでにカバーされている保護に加えて、2つのさらなる保護のうちの1つを追加します。上記のフラグはクッキー上で誤って設定を解除される可能性がありますが、名前は変更されませんので、セキュリティ属性を定義するために名前を使用することでより確実にフラグを強制できます。</p>
<p>現在のところ、クッキーの名前の前には<code>__Secure-</code>か<code>__Host-</code>のどちらかを付けることができ、どちらもクッキーに追加のセキュリティを提供しています。</p>
<figure>
  <div class="table-wrap">
    <div class="table-wrap-container">
      <table>
        <tbody>
          <tr>
            <td></td>
            <th scope="colgroup" colspan="2">ホームページ数</th>
            <th scope="colgroup" colspan="2">ホームページの割合</th>
          </tr>
          <tr>
            <th scope="col">プレフィックス値</th>
            <th scope="col">デスクトップ</th>
            <th scope="col">モバイル</th>
            <th scope="col">デスクトップ</th>
            <th scope="col">モバイル</th>
          </tr>
          <tr>
            <td><code>__Secure-</code></td>
            <td>640</td>
            <td>628</td>
            <td>0.01%</td>
            <td>0.01%</td>
          </tr>
          <tr>
            <td><code>__Host-</code></td>
            <td>154</td>
            <td>157</td>
            <td>0.00%</td>
            <td>0.00%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <figcaption><a href="#fig-17" class="anchor-link">図 17.</a> クッキーのプレフィックスの使用法</figcaption>
</figure>
<p>図が示すように、どちらのプレフィックスの使用率も信じられないほど低いのですが、2つのプレフィックスが緩和されているため<code>__Secure-</code>プレフィックスの方がすでに利用率は高いです。</p>
<h2 id="サブリソースの完全性"><a href="#サブリソースの完全性" class="anchor-link">サブリソースの完全性</a></h2>
<p>最近増えているもう1つの問題は、サードパーティの依存関係のセキュリティです。サードパーティからスクリプトファイルを読み込む際には、スクリプトファイルが常に欲しいライブラリ、おそらく特定のバージョンのjQueryであることを期待します。CDNやサードパーティのホスティングサービスが危殆化した場合、それらをホスティングしているスクリプトファイルを変更される可能性があります。このシナリオでは、アプリケーションは訪問者に危害を加える可能性のある悪意あるJavaScriptを読み込んでいることになります。これが、サブリソースの完全性が保護する機能です。</p>
<p>スクリプトやリンクタグに<code>integrity</code>属性を追加することで、ブラウザはサードパーティのリソースの整合性をチェックし、変更された場合は拒否できます。</p>
<pre><code>&lt;script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"&gt;&lt;/script&gt;</code></pre>
<p>整合性属性が設定されたリンクまたはスクリプトタグを含むデスクトップページの0.06％（247,604）とモバイルページの0.05％（272,167）しかないため、SRIの使用には多くの改善の余地があります。現在、多くのCDNがSRIの整合性属性を含むコードサンプルを提供しているため、SRIの使用は着実に増加していると思われます。</p>
<h2 id="結論"><a href="#結論" class="anchor-link">結論</a></h2>
<p>Webの機能が向上し、より多くの機密データへのアクセスが可能になるにつれ、開発者が自社のアプリケーションを保護するためにWebセキュリティ機能を採用することがますます重要になってきています。本章でレビューするセキュリティ機能は、Webプラットフォーム自体に組み込まれた防御機能であり、すべてのWeb制作者が利用可能です。しかし、本章の研究結果のレビューからもわかるように、いくつかの重要なセキュリティメカニズムはウェブの一部にしか適用されていないため、エコシステムのかなりの部分がセキュリティやプライバシーのバグにさらされたままとなっています。</p>
<h3 id="暗号化"><a href="#暗号化" class="anchor-link">暗号化</a></h3>
<p>ここ数年の間に、転送中データの暗号化については、Webが最も進歩しています。<a href="#トランスポートレイヤーセキュリティ">TLSセクション</a>で説明したように、ブラウザーベンダー、開発者、Let's Encryptのような認証局の様々な努力のおかげで、HTTPSを使用しているウェブの割合は着実に増加しています。本稿執筆時点では、大多数のサイトがHTTPSで利用可能であり、トラフィックの機密性と完全性が確保されています。重要なことに、HTTPSを有効にしているWebサイトの99％以上では、TLSプロトコルの新しい安全なバージョン（TLSv1.2およびTLSv1.3）が使用されています。GCMモードでのAESなどの強力な<a href="#暗号スイート">cipher suites</a>の使用率も高く、すべてのプラットフォームで95％以上のリクエストを占めています。</p>
<p>同時に、TLS設定のギャップは依然としてかなり一般的です。15％以上のページが<a href="#混合コンテンツ">混合コンテンツ</a>の問題に悩まされており、ブラウザに警告が表示され、4％のサイトではセキュリティ上の理由から最新のブラウザにブロックされています。同様に、<a href="#http-strict-transport-security">HTTP Strict Transport Security</a>の利点は、主要なサイトのごく一部にしか及ばず、大多数のWebサイトでは最も安全なHSTS構成を有効にしておらず、<a href="#hstsプリロード">HSTS プリロード</a>の対象外となっています。HTTPSの採用が進んでいるにもかかわらず、未だに多くのクッキーが<code>Secure</code>フラグなしで設定されており、クッキーを設定しているホームページのうち、暗号化されていないHTTPでの送信を防止しているのはわずか4％に過ぎません。</p>
<h3 id="一般的なウェブの脆弱性からの防御"><a href="#一般的なウェブの脆弱性からの防御" class="anchor-link">一般的なウェブの脆弱性からの防御</a></h3>
<p>
  機密データを扱うサイトで作業するウェブ開発者は、<a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0wiki/Cross-site_scripting">XSS</a>、<a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA">CSRF</a>、<a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AA%E3%83%83%E3%82%AF%E3%82%B8%E3%83%A3%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0">クリックジャッキング</a>、およびその他の一般的なウェブバグからアプリケーションを保護するために、オプトインウェブセキュリティ機能を有効にしていることがよくあります。これらの問題は、<a href="#x-frame-options"><code>X-Frame-Options</code></a
  >、<a href="#x-content-type-options"><code>X-Content-Type-Options</code></a
  >、<a href="#コンテンツセキュリティポリシー"><code>コンテンツセキュリティポリシー</code></a
  >を含む、多くの標準的で広くサポートされているHTTPレスポンスヘッダを設定することで緩和できます。
</p>
<p>
  セキュリティ機能とウェブアプリケーションの両方共複雑であることが大部分を占めていますが、現在これらの防御機能を利用しているウェブサイトは少数派であり、多くの場合、リファクタリングの努力を必要としないメカニズムのみを有効にしています。最も一般的なオプトインアプリケーションのセキュリティ機能は、<code>X-Content-Type-Options</code> (17％のページで有効)、<code>X-Frame-Options</code> (16％)、および非推奨の<code>X-XSS-Protection</code>ヘッダ(15％)です。最も強力なWebセキュリティメカニズムであるコンテンツセキュリティポリシーは、5％のWebサイトでしか有効になっておらず、そのうちのごく一部(全サイトの約0.1％)だけが<a href="#ハッシュノンス">CSP ナンスとハッシュ</a>に基づいたより安全な設定を使用しています。関連する <a href="#参照元ポリシー"><code>参照元ポリシー</code></a
  >は、<code>Referer</code>ヘッダーで第三者に送信される情報量を減らすことを目的としているが、同様に使用しているのは3％のウェブサイトのみです。
</p>
<h3 id="現代のウェブプラットフォームの防御"><a href="#現代のウェブプラットフォームの防御" class="anchor-link">現代のウェブプラットフォームの防御</a></h3>
<p>近年、ブラウザーは、主要な脆弱性や新たなWeb脅威からの保護を提供する強力な新しいメカニズムを実装しています; これには、<a href="#サブリソースの完全性">サブリソースの完全性</a>、<a href="#同じサイトのクッキー">同じサイトのクッキー</a>、および<a href="#クッキーのプレフィックス">クッキーのプレフィックス</a>が含まれます。</p>
<p>これらの機能は比較的少数のウェブサイトでしか採用されていません。<a href="https://w3c.github.io/webappsec-trusted-types/dist/spec/">Trusted Types</a>、<a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Cross-Origin_Resource_Policy_(CORP)">オリジン間リソース共有</a>、<a href="https://www.chromestatus.com/feature/5432089535053824">オリジン間オープナー共有</a>のような、さらに最近のセキュリティメカニズムは、まだ広く採用されていません。</p>
<p>
  同様に、<a href="#report-to">Reporting API</a>、<a href="#ネットワークエラーロギング">ネットワークエラーロギング</a>、<a href="#クリアサイトデータ"><code>Clear-Site-Data</code></a
  >ヘッダのような便利な機能もまだ初期段階であり、現在は少数のサイトで利用されています。
</p>
<h2 id="結びつき"><a href="#結びつき" class="anchor-link">結びつき</a></h2>
<p>ウェブの規模では、オプトインプラットフォームのセキュリティ機能の全体的なカバー率は、現在のところ比較的低い。最も広く採用されている保護であっても、一般的なセキュリティ問題に対するプラットフォームのセーフガードを持たないウェブの大部分を残して、ウェブサイトの4分の1未満で有効になっています。</p>
<p>しかし、これらのメカニズムの採用は、より機密性の高いユーザーデータを頻繁に扱う大規模なウェブアプリケーションに偏っていることに注意することが重要です。これらのサイトの開発者は、一般的な脆弱性に対する様々な保護を可能にすることを含め、ウェブの防御力を向上させるために投資することが多くなっています。<a href="https://observatory.mozilla.org/">Mozilla Observatory</a>や<a href="https://securityheaders.com/">Security Headers</a>などのツールは、ウェブで利用可能なセキュリティ機能の便利なチェックリストを提供してくれます。</p>
<p>ウェブアプリケーションが機密性の高いユーザーデータを扱う場合はユーザーを保護し、ウェブをより安全にするためこのセクションで概説されているセキュリティメカニズムを有効にすることを検討してください。</p>
{% endblock %}
