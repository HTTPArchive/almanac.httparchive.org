name: Progress Tracker

on:
  workflow_dispatch:
  issues:
    types:
      - edited

jobs:
  track-progress:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v2
        with:
          script: |
            // Update the following two constants each year
            const FILTER_LABEL = '2020 chapter'
            const TRACKER_ISSUE_ID = 989

            const parseTasks = text => {
              const tasks = []
              text.split('\n').forEach(line => {
                if (/^(\s{2,})?([*+-]|\d+\.)\s+\[ \]\s+\S+/.test(line)) {
                  tasks.push('')
                }
                if (/^(\s{2,})?([*+-]|\d+\.)\s+\[[xX]\]\s+\S+/.test(line)) {
                  tasks.push('☑')
                }
              })
              return tasks
            }

            const parseLinks = text => {
              const links = {}
              text.split('\n').forEach(line => {
                const linkMap = {
                  draft: /^\[~draft-doc\]:\s*(?<link>\S+)/,
                  sql: /^\[~sql-dir\]:\s*(?<link>\S+)/,
                  results: /^\[~results-sheet\]:\s*(?<link>\S+)/
                }
                for (const [k, v] of Object.entries(linkMap)) {
                  const m = line.match(v)
                  if (m) {
                    links[k] = m.groups.link
                  }
                }
              })
              return links
            }

            const parseTeam = text => {
              const team = {}
              text.split('\n').forEach(line => {
                if (/\|\s*\[Sheet\]\[~results-sheet\]\s*\|/.test(line)) {
                  const [, authors, reviewers, analysts] = line.split('|')
                  team.authors = [...authors.matchAll(/@(?<username>\w+)/g)].map(u => u.groups.username)
                  team.reviewers = [...reviewers.matchAll(/@(?<username>\w+)/g)].map(u => u.groups.username)
                  team.analysts = [...analysts.matchAll(/@(?<username>\w+)/g)].map(u => u.groups.username)
                }
              })
              return team
            }

            const formatLinks = links => {
              const icons = {
                draft: '🗎',
                sql: '⛁',
                results: '⚝'
              }
              return Object.entries(links).filter(l => l[1] && l[1] != '#').map(l => `[${icons[l[0]] || l[0]}](${l[1]})`).join(' ')
            }

            const formatTeam = team => {
              return Object.entries(team).map(m => m[1].length).join('/')
            }

            const taskIssues = await github.paginate(github.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              direction: 'asc',
              labels: FILTER_LABEL
            })

            let report = ''
            let taskCount = 0
            for (const issue of taskIssues) {
              const tasksStatus = parseTasks(issue.body)
              if(!report) {
                taskCount = tasksStatus.length
                report = `Chapters | Links | Team | ${tasksStatus.map((v, i) => i + 1).join(' | ')}\n`
                report += `:--------|:------|:----:|:${tasksStatus.map(() => '-').join(':|:')}:\n`
              }
              if(!tasksStatus.length || tasksStatus.length != taskCount) {
                continue
              }
              const links = formatLinks(parseLinks(issue.body))
              const team = formatTeam(parseTeam(issue.body))
              report += `[${issue.title.replace(/\s+\d+$/, '')}](${issue.html_url}) | ${links} | ${team} | ${tasksStatus.join(' | ')}\n`
            }

            const progressIssue = await github.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: TRACKER_ISSUE_ID
            })

            github.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: TRACKER_ISSUE_ID,
              body: progressIssue.data.body.replace(/<!-- REPORT START -->[\s\S]*<!-- REPORT END -->/, `<!-- REPORT START -->\n${report}<!-- REPORT END -->`)
            })
