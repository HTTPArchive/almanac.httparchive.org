CREATE TEMP FUNCTION detect(codepoints ARRAY<STRING>)
RETURNS ARRAY<STRING>
LANGUAGE js AS r"""

# This function and data taken from https://github.com/bramstein/detect-writing-script (BSD-3-Clause)
const scripts = {"Latin":[[65,90],[97,122],[170,170],[186,186],[192,214],[216,246],[248,696],[736,740],[7424,7461],[7468,7516],[7522,7525],[7531,7543],[7545,7614],[7680,7935],[8305,8305],[8319,8319],[8336,8348],[8490,8490],[8491,8491],[8498,8498],[8526,8526],[8544,8584],[11360,11391],[42786,42887],[42891,42943],[42946,42950],[42999,43007],[43824,43866],[43868,43876],[43878,43878],[43879,43879],[64256,64262],[65313,65338],[65345,65370]],"Greek":[[880,883],[885,887],[890,893],[895,895],[900,900],[902,902],[904,906],[908,908],[910,929],[931,993],[1008,1023],[7462,7466],[7517,7521],[7526,7530],[7615,7615],[7936,7957],[7960,7965],[7968,8005],[8008,8013],[8016,8023],[8025,8025],[8027,8027],[8029,8029],[8031,8061],[8064,8116],[8118,8132],[8134,8147],[8150,8155],[8157,8175],[8178,8180],[8182,8190],[8486,8486],[43877,43877],[65856,65934],[65952,65952],[119296,119365]],"Cyrillic":[[1024,1156],[1159,1327],[7296,7304],[7467,7467],[7544,7544],[11744,11775],[42560,42655],[65070,65070],[65071,65071]],"Armenian":[[1329,1366],[1369,1416],[1418,1418],[1421,1423],[64275,64279]],"Hebrew":[[1425,1479],[1488,1514],[1519,1524],[64285,64310],[64312,64316],[64318,64318],[64320,64320],[64321,64321],[64323,64323],[64324,64324],[64326,64335]],"Arabic":[[1536,1540],[1542,1547],[1549,1562],[1564,1564],[1566,1566],[1568,1599],[1601,1610],[1622,1647],[1649,1756],[1758,1791],[1872,1919],[2208,2228],[2230,2237],[2259,2273],[2275,2303],[64336,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65021],[65136,65140],[65142,65276],[69216,69246],[126464,126467],[126469,126495],[126497,126497],[126498,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126545],[126546,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126561],[126562,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[126704,126704],[126705,126705]],"Syriac":[[1792,1805],[1807,1866],[1869,1871],[2144,2154]],"Thaana":[[1920,1969]],"Devanagari":[[2304,2384],[2389,2403],[2406,2431],[43232,43263]],"Bengali":[[2432,2435],[2437,2444],[2447,2447],[2448,2448],[2451,2472],[2474,2480],[2482,2482],[2486,2489],[2492,2500],[2503,2503],[2504,2504],[2507,2510],[2519,2519],[2524,2524],[2525,2525],[2527,2531],[2534,2558]],"Gurmukhi":[[2561,2563],[2565,2570],[2575,2575],[2576,2576],[2579,2600],[2602,2608],[2610,2610],[2611,2611],[2613,2613],[2614,2614],[2616,2616],[2617,2617],[2620,2620],[2622,2626],[2631,2631],[2632,2632],[2635,2637],[2641,2641],[2649,2652],[2654,2654],[2662,2678]],"Gujarati":[[2689,2691],[2693,2701],[2703,2705],[2707,2728],[2730,2736],[2738,2738],[2739,2739],[2741,2745],[2748,2757],[2759,2761],[2763,2765],[2768,2768],[2784,2787],[2790,2801],[2809,2815]],"Oriya":[[2817,2819],[2821,2828],[2831,2831],[2832,2832],[2835,2856],[2858,2864],[2866,2866],[2867,2867],[2869,2873],[2876,2884],[2887,2887],[2888,2888],[2891,2893],[2902,2902],[2903,2903],[2908,2908],[2909,2909],[2911,2915],[2918,2935]],"Tamil":[[2946,2946],[2947,2947],[2949,2954],[2958,2960],[2962,2965],[2969,2969],[2970,2970],[2972,2972],[2974,2974],[2975,2975],[2979,2979],[2980,2980],[2984,2986],[2990,3001],[3006,3010],[3014,3016],[3018,3021],[3024,3024],[3031,3031],[3046,3066],[73664,73713],[73727,73727]],"Telugu":[[3072,3084],[3086,3088],[3090,3112],[3114,3129],[3133,3140],[3142,3144],[3146,3149],[3157,3157],[3158,3158],[3160,3162],[3168,3171],[3174,3183],[3191,3199]],"Kannada":[[3200,3212],[3214,3216],[3218,3240],[3242,3251],[3253,3257],[3260,3268],[3270,3272],[3274,3277],[3285,3285],[3286,3286],[3294,3294],[3296,3299],[3302,3311],[3313,3313],[3314,3314]],"Malayalam":[[3328,3331],[3333,3340],[3342,3344],[3346,3396],[3398,3400],[3402,3407],[3412,3427],[3430,3455]],"Sinhala":[[3458,3458],[3459,3459],[3461,3478],[3482,3505],[3507,3515],[3517,3517],[3520,3526],[3530,3530],[3535,3540],[3542,3542],[3544,3551],[3558,3567],[3570,3572],[70113,70132]],"Thai":[[3585,3642],[3648,3675]],"Lao":[[3713,3713],[3714,3714],[3716,3716],[3718,3722],[3724,3747],[3749,3749],[3751,3773],[3776,3780],[3782,3782],[3784,3789],[3792,3801],[3804,3807]],"Tibetan":[[3840,3911],[3913,3948],[3953,3991],[3993,4028],[4030,4044],[4046,4052],[4057,4057],[4058,4058]],"Myanmar":[[4096,4255],[43488,43518],[43616,43647]],"Georgian":[[4256,4293],[4295,4295],[4301,4301],[4304,4346],[4348,4351],[7312,7354],[7357,7359],[11520,11557],[11559,11559],[11565,11565]],"Hangul":[[4352,4607],[12334,12334],[12335,12335],[12593,12686],[12800,12830],[12896,12926],[43360,43388],[44032,55203],[55216,55238],[55243,55291],[65440,65470],[65474,65479],[65482,65487],[65490,65495],[65498,65500]],"Ethiopic":[[4608,4680],[4682,4685],[4688,4694],[4696,4696],[4698,4701],[4704,4744],[4746,4749],[4752,4784],[4786,4789],[4792,4798],[4800,4800],[4802,4805],[4808,4822],[4824,4880],[4882,4885],[4888,4954],[4957,4988],[4992,5017],[11648,11670],[11680,11686],[11688,11694],[11696,11702],[11704,11710],[11712,11718],[11720,11726],[11728,11734],[11736,11742],[43777,43782],[43785,43790],[43793,43798],[43808,43814],[43816,43822]],"Cherokee":[[5024,5109],[5112,5117],[43888,43967]],"Canadian_Aboriginal":[[5120,5759],[6320,6389]],"Khmer":[[6016,6109],[6112,6121],[6128,6137],[6624,6655]],"Mongolian":[[6144,6144],[6145,6145],[6148,6148],[6150,6158],[6160,6169],[6176,6264],[6272,6314],[71264,71276]],"Hiragana":[[12353,12438],[12445,12447],[110593,110878],[110928,110930],[127488,127488]],"Katakana":[[12449,12538],[12541,12543],[12784,12799],[13008,13054],[13056,13143],[65382,65391],[65393,65437],[110592,110592],[110948,110951]],"Bopomofo":[[746,746],[747,747],[12549,12591],[12704,12730]],"Han":[[11904,11929],[11931,12019],[12032,12245],[12293,12293],[12295,12295],[12321,12329],[12344,12347],[13312,19893],[19968,40943],[63744,64109],[64112,64217],[131072,173782],[173824,177972],[177984,178205],[178208,183969],[183984,191456],[194560,195101]],"Yi":[[40960,42124],[42128,42182]],"Deseret":[[66560,66639]],"Tagalog":[[5888,5900],[5902,5908]],"Hanunoo":[[5920,5940]],"Buhid":[[5952,5971]],"Tagbanwa":[[5984,5996],[5998,6000],[6002,6002],[6003,6003]],"Limbu":[[6400,6430],[6432,6443],[6448,6459],[6464,6464],[6468,6479]],"Tai_Le":[[6480,6509],[6512,6516]],"Shavian":[[66640,66687]],"Osmanya":[[66688,66717],[66720,66729]],"Braille":[[10240,10495]],"Buginese":[[6656,6683],[6686,6686],[6687,6687]],"New_Tai_Lue":[[6528,6571],[6576,6601],[6608,6618],[6622,6622],[6623,6623]],"Tifinagh":[[11568,11623],[11631,11631],[11632,11632],[11647,11647]],"Balinese":[[6912,6987],[6992,7036]],"Nko":[[1984,2042],[2045,2047]],"Sundanese":[[7040,7103],[7360,7367]],"Lepcha":[[7168,7223],[7227,7241],[7245,7247]],"Ol_Chiki":[[7248,7295]],"Vai":[[42240,42539]],"Saurashtra":[[43136,43205],[43214,43225]],"Kayah_Li":[[43264,43309],[43311,43311]],"Rejang":[[43312,43347],[43359,43359]],"Cham":[[43520,43574],[43584,43597],[43600,43609],[43612,43615]],"Tai_Tham":[[6688,6750],[6752,6780],[6783,6793],[6800,6809],[6816,6829]],"Tai_Viet":[[43648,43714],[43739,43743]],"Samaritan":[[2048,2093],[2096,2110]],"Lisu":[[42192,42239]],"Bamum":[[42656,42743],[92160,92728]],"Javanese":[[43392,43469],[43472,43481],[43486,43486],[43487,43487]],"Meetei_Mayek":[[43744,43766],[43968,44013],[44016,44025]],"Inscriptional_Pahlavi":[[68448,68466],[68472,68479]],"Batak":[[7104,7155],[7164,7167]],"Mandaic":[[2112,2139],[2142,2142]],"Chakma":[[69888,69940],[69942,69958]],"Miao":[[93952,94026],[94031,94087],[94095,94111]],"Sharada":[[70016,70093],[70096,70111]],"Sora_Sompeng":[[69840,69864],[69872,69881]],"Takri":[[71296,71352],[71360,71369]],"Duployan":[[113664,113770],[113776,113788],[113792,113800],[113808,113817],[113820,113823]],"Pahawh_Hmong":[[92928,92997],[93008,93017],[93019,93025],[93027,93047],[93053,93071]],"Mende_Kikakui":[[124928,125124],[125127,125142]],"Mro":[[92736,92766],[92768,92777],[92782,92782],[92783,92783]],"Pau_Cin_Hau":[[72384,72440]],"Khudawadi":[[70320,70378],[70384,70393]],"Tirhuta":[[70784,70855],[70864,70873]],"Warang_Citi":[[71840,71922],[71935,71935]],"SignWriting":[[120832,121483],[121499,121503],[121505,121519]],"Adlam":[[125184,125259],[125264,125273],[125278,125278],[125279,125279]],"Newa":[[70656,70745],[70747,70747],[70749,70751]],"Osage":[[66736,66771],[66776,66811]],"Masaram_Gondi":[[72960,72966],[72968,72968],[72969,72969],[72971,73014],[73018,73018],[73020,73020],[73021,73021],[73023,73031],[73040,73049]],"Nushu":[[94177,94177],[110960,111355]],"Gunjala_Gondi":[[73056,73061],[73063,73063],[73064,73064],[73066,73102],[73104,73104],[73105,73105],[73107,73112],[73120,73129]],"Medefaidrin":[[93760,93850]],"Hanifi_Rohingya":[[68864,68903],[68912,68921]],"Nyiakeng_Puachue_Hmong":[[123136,123180],[123184,123197],[123200,123209],[123214,123214],[123215,123215]],"Wancho":[[123584,123641],[123647,123647]],"PUA":[[57344,63743],[983040,1048573],[1048576,1114109]],"Emoji":[[35,35],[42,42],[48,57],[169,169],[174,174],[8252,8252],[8265,8265],[8482,8482],[8505,8505],[8596,8601],[8617,8617],[8618,8618],[8986,8986],[8987,8987],[9000,9000],[9167,9167],[9193,9203],[9208,9210],[9410,9410],[9642,9642],[9643,9643],[9654,9654],[9664,9664],[9723,9726],[9728,9732],[9742,9742],[9745,9745],[9748,9748],[9749,9749],[9752,9752],[9757,9757],[9760,9760],[9762,9762],[9763,9763],[9766,9766],[9770,9770],[9774,9774],[9775,9775],[9784,9786],[9792,9792],[9794,9794],[9800,9811],[9823,9823],[9824,9824],[9827,9827],[9829,9829],[9830,9830],[9832,9832],[9851,9851],[9854,9854],[9855,9855],[9874,9879],[9881,9881],[9883,9883],[9884,9884],[9888,9888],[9889,9889],[9895,9895],[9898,9898],[9899,9899],[9904,9904],[9905,9905],[9917,9917],[9918,9918],[9924,9924],[9925,9925],[9928,9928],[9934,9934],[9935,9935],[9937,9937],[9939,9939],[9940,9940],[9961,9961],[9962,9962],[9968,9973],[9975,9978],[9981,9981],[9986,9986],[9989,9989],[9992,9997],[9999,9999],[10002,10002],[10004,10004],[10006,10006],[10013,10013],[10017,10017],[10024,10024],[10035,10035],[10036,10036],[10052,10052],[10055,10055],[10060,10060],[10062,10062],[10067,10069],[10071,10071],[10083,10083],[10084,10084],[10133,10135],[10145,10145],[10160,10160],[10175,10175],[10548,10548],[10549,10549],[11013,11015],[11035,11035],[11036,11036],[11088,11088],[11093,11093],[12336,12336],[12349,12349],[12951,12951],[12953,12953],[126980,126980],[127183,127183],[127344,127344],[127345,127345],[127358,127358],[127359,127359],[127374,127374],[127377,127386],[127462,127487],[127489,127489],[127490,127490],[127514,127514],[127535,127535],[127538,127546],[127568,127568],[127569,127569],[127744,127777],[127780,127891],[127894,127894],[127895,127895],[127897,127899],[127902,127984],[127987,127989],[127991,128253],[128255,128317],[128329,128334],[128336,128359],[128367,128367],[128368,128368],[128371,128378],[128391,128391],[128394,128397],[128400,128400],[128405,128405],[128406,128406],[128420,128420],[128421,128421],[128424,128424],[128433,128433],[128434,128434],[128444,128444],[128450,128452],[128465,128467],[128476,128478],[128481,128481],[128483,128483],[128488,128488],[128495,128495],[128499,128499],[128506,128591],[128640,128709],[128715,128722],[128725,128727],[128733,128741],[128745,128745],[128747,128747],[128748,128748],[128752,128752],[128755,128764],[128992,129003],[129008,129008],[129292,129338],[129340,129349],[129351,129535],[129648,129652],[129656,129660],[129664,129670],[129680,129708],[129712,129722],[129728,129733],[129744,129753],[129760,129767],[129776,129782]],"Emoji_Presentation":[[8986,8986],[8987,8987],[9193,9196],[9200,9200],[9203,9203],[9725,9725],[9726,9726],[9748,9748],[9749,9749],[9800,9811],[9855,9855],[9875,9875],[9889,9889],[9898,9898],[9899,9899],[9917,9917],[9918,9918],[9924,9924],[9925,9925],[9934,9934],[9940,9940],[9962,9962],[9970,9970],[9971,9971],[9973,9973],[9978,9978],[9981,9981],[9989,9989],[9994,9994],[9995,9995],[10024,10024],[10060,10060],[10062,10062],[10067,10069],[10071,10071],[10133,10135],[10160,10160],[10175,10175],[11035,11035],[11036,11036],[11088,11088],[11093,11093],[126980,126980],[127183,127183],[127374,127374],[127377,127386],[127462,127487],[127489,127489],[127514,127514],[127535,127535],[127538,127542],[127544,127546],[127568,127568],[127569,127569],[127744,127776],[127789,127797],[127799,127868],[127870,127891],[127904,127946],[127951,127955],[127968,127984],[127988,127988],[127992,128062],[128064,128064],[128066,128252],[128255,128317],[128331,128334],[128336,128359],[128378,128378],[128405,128405],[128406,128406],[128420,128420],[128507,128591],[128640,128709],[128716,128716],[128720,128722],[128725,128727],[128733,128735],[128747,128747],[128748,128748],[128756,128764],[128992,129003],[129008,129008],[129292,129338],[129340,129349],[129351,129535],[129648,129652],[129656,129660],[129664,129670],[129680,129708],[129712,129722],[129728,129733],[129744,129753],[129760,129767],[129776,129782]],"Emoji_Modifier":[[127995,127999]],"Emoji_Modifier_Base":[[9757,9757],[9977,9977],[9994,9997],[127877,127877],[127938,127940],[127943,127943],[127946,127948],[128066,128066],[128067,128067],[128070,128080],[128102,128120],[128124,128124],[128129,128131],[128133,128135],[128143,128143],[128145,128145],[128170,128170],[128372,128372],[128373,128373],[128378,128378],[128400,128400],[128405,128405],[128406,128406],[128581,128583],[128587,128591],[128675,128675],[128692,128694],[128704,128704],[128716,128716],[129292,129292],[129295,129295],[129304,129311],[129318,129318],[129328,129337],[129340,129342],[129399,129399],[129461,129461],[129462,129462],[129464,129464],[129465,129465],[129467,129467],[129485,129487],[129489,129501],[129731,129733],[129776,129782]],"Emoji_Component":[[35,35],[42,42],[48,57],[8205,8205],[8419,8419],[65039,65039],[127462,127487],[127995,127999],[129456,129459],[917536,917631]],"Extended_Pictographic":[[169,169],[174,174],[8252,8252],[8265,8265],[8482,8482],[8505,8505],[8596,8601],[8617,8617],[8618,8618],[8986,8986],[8987,8987],[9000,9000],[9096,9096],[9167,9167],[9193,9203],[9208,9210],[9410,9410],[9642,9642],[9643,9643],[9654,9654],[9664,9664],[9723,9726],[9728,9733],[9735,9746],[9748,9861],[9872,9989],[9992,10002],[10004,10004],[10006,10006],[10013,10013],[10017,10017],[10024,10024],[10035,10035],[10036,10036],[10052,10052],[10055,10055],[10060,10060],[10062,10062],[10067,10069],[10071,10071],[10083,10087],[10133,10135],[10145,10145],[10160,10160],[10175,10175],[10548,10548],[10549,10549],[11013,11015],[11035,11035],[11036,11036],[11088,11088],[11093,11093],[12336,12336],[12349,12349],[12951,12951],[12953,12953],[126976,127231],[127245,127247],[127279,127279],[127340,127345],[127358,127358],[127359,127359],[127374,127374],[127377,127386],[127405,127461],[127489,127503],[127514,127514],[127535,127535],[127538,127546],[127548,127551],[127561,127994],[128000,128317],[128326,128591],[128640,128767],[128884,128895],[128981,129023],[129036,129039],[129096,129103],[129114,129119],[129160,129167],[129198,129279],[129292,129338],[129340,129349],[129351,129791],[130048,131069]]};

const names = Object.keys(scripts);
const ranges = Object.values(scripts);
const totals = new Array(names.length).fill(0);
const counts = new Array(names.length);

// Calculate the total number of codepoints for each script. We
// can easily do this by summing the number of codepoints in
// each range and script.
for (let i = 0; i < ranges.length; i++) {
  for (let j = 0; j < ranges[i].length; j++) {
    totals[i] += ranges[i][j][1] - ranges[i][j][0];
  }
}

function detect(codepoints, confidence) {
  // Reset the counts array
  counts.fill(0);

  for (let j = 0; j < codepoints.length; j++) {
    all:
    for (let i = 0; i < ranges.length; i++) {
      for (let k = 0; k < ranges[i].length; k++) {
        // Exit the outer loop (script) if the codepoint has been found.
        // The ranges don't repeat so we won't find the codepoint again.
        if (codepoints[j] >= ranges[i][k][0] && codepoints[j] <= ranges[i][k][1]) {
          counts[i]++;
          break all; // NOTE: This uses a label to jump out of both loops at once.
        }

        // Also exit the inner loop (ranges) early if the codepoint is smaller,
        // as we won't find the codepoint in subsequent ranges.
        if (ranges[i][k][0] > codepoints[j]) {
          break;
        }
      }
    }
  }

  const result = [];

  for (let i = 0; i < names.length; i++) {
    if (counts[i] / totals[i] > confidence) {
      result.push(names[i]);
    }

    if (names[i] === 'PUA' && counts[i] > 0) {
      result.push(names[i]);
    }
  }

  return result;
}

if (codepoints === null) {
  return [];
}

return detect(codepoints.map(c => parseInt(c, 10)), 0.25);
""";

SELECT
  client,
  script,
  COUNT(DISTINCT page) AS pages_script,
  total_page,
  COUNT(DISTINCT page) / total_page AS pct_script
FROM (
  SELECT
    client,
    page,
    payload
  FROM
    `httparchive.almanac.requests`
  WHERE
    date = '2022-06-01' AND
    type = 'font')
JOIN (
  SELECT
    _TABLE_SUFFIX AS client,
    COUNT(0) AS total_page
  FROM
    `httparchive.pages.2022_06_01_*`
  GROUP BY
    _TABLE_SUFFIX)
USING
  (client),
  UNNEST(detect(JSON_EXTRACT_STRING_ARRAY(payload, '$._font_details.cmap.codepoints'))) AS script
GROUP BY
  client,
  total_page,
  script
ORDER BY
  pages_script DESC
