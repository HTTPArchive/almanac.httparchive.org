CREATE TEMP FUNCTION
hasEmoji(codepoints ARRAY<STRING>)
RETURNS BOOL
LANGUAGE js AS r"""
const scripts = {"Emoji":[[35,35],[42,42],[48,57],[169,169],[174,174],[8252,8252],[8265,8265],[8482,8482],[8505,8505],[8596,8601],[8617,8617],[8618,8618],[8986,8986],[8987,8987],[9000,9000],[9167,9167],[9193,9203],[9208,9210],[9410,9410],[9642,9642],[9643,9643],[9654,9654],[9664,9664],[9723,9726],[9728,9732],[9742,9742],[9745,9745],[9748,9748],[9749,9749],[9752,9752],[9757,9757],[9760,9760],[9762,9762],[9763,9763],[9766,9766],[9770,9770],[9774,9774],[9775,9775],[9784,9786],[9792,9792],[9794,9794],[9800,9811],[9823,9823],[9824,9824],[9827,9827],[9829,9829],[9830,9830],[9832,9832],[9851,9851],[9854,9854],[9855,9855],[9874,9879],[9881,9881],[9883,9883],[9884,9884],[9888,9888],[9889,9889],[9895,9895],[9898,9898],[9899,9899],[9904,9904],[9905,9905],[9917,9917],[9918,9918],[9924,9924],[9925,9925],[9928,9928],[9934,9934],[9935,9935],[9937,9937],[9939,9939],[9940,9940],[9961,9961],[9962,9962],[9968,9973],[9975,9978],[9981,9981],[9986,9986],[9989,9989],[9992,9997],[9999,9999],[10002,10002],[10004,10004],[10006,10006],[10013,10013],[10017,10017],[10024,10024],[10035,10035],[10036,10036],[10052,10052],[10055,10055],[10060,10060],[10062,10062],[10067,10069],[10071,10071],[10083,10083],[10084,10084],[10133,10135],[10145,10145],[10160,10160],[10175,10175],[10548,10548],[10549,10549],[11013,11015],[11035,11035],[11036,11036],[11088,11088],[11093,11093],[12336,12336],[12349,12349],[12951,12951],[12953,12953],[126980,126980],[127183,127183],[127344,127344],[127345,127345],[127358,127358],[127359,127359],[127374,127374],[127377,127386],[127462,127487],[127489,127489],[127490,127490],[127514,127514],[127535,127535],[127538,127546],[127568,127568],[127569,127569],[127744,127777],[127780,127891],[127894,127894],[127895,127895],[127897,127899],[127902,127984],[127987,127989],[127991,128253],[128255,128317],[128329,128334],[128336,128359],[128367,128367],[128368,128368],[128371,128378],[128391,128391],[128394,128397],[128400,128400],[128405,128405],[128406,128406],[128420,128420],[128421,128421],[128424,128424],[128433,128433],[128434,128434],[128444,128444],[128450,128452],[128465,128467],[128476,128478],[128481,128481],[128483,128483],[128488,128488],[128495,128495],[128499,128499],[128506,128591],[128640,128709],[128715,128722],[128725,128727],[128733,128741],[128745,128745],[128747,128747],[128748,128748],[128752,128752],[128755,128764],[128992,129003],[129008,129008],[129292,129338],[129340,129349],[129351,129535],[129648,129652],[129656,129660],[129664,129670],[129680,129708],[129712,129722],[129728,129733],[129744,129753],[129760,129767],[129776,129782]],"Emoji_Presentation":[[8986,8986],[8987,8987],[9193,9196],[9200,9200],[9203,9203],[9725,9725],[9726,9726],[9748,9748],[9749,9749],[9800,9811],[9855,9855],[9875,9875],[9889,9889],[9898,9898],[9899,9899],[9917,9917],[9918,9918],[9924,9924],[9925,9925],[9934,9934],[9940,9940],[9962,9962],[9970,9970],[9971,9971],[9973,9973],[9978,9978],[9981,9981],[9989,9989],[9994,9994],[9995,9995],[10024,10024],[10060,10060],[10062,10062],[10067,10069],[10071,10071],[10133,10135],[10160,10160],[10175,10175],[11035,11035],[11036,11036],[11088,11088],[11093,11093],[126980,126980],[127183,127183],[127374,127374],[127377,127386],[127462,127487],[127489,127489],[127514,127514],[127535,127535],[127538,127542],[127544,127546],[127568,127568],[127569,127569],[127744,127776],[127789,127797],[127799,127868],[127870,127891],[127904,127946],[127951,127955],[127968,127984],[127988,127988],[127992,128062],[128064,128064],[128066,128252],[128255,128317],[128331,128334],[128336,128359],[128378,128378],[128405,128405],[128406,128406],[128420,128420],[128507,128591],[128640,128709],[128716,128716],[128720,128722],[128725,128727],[128733,128735],[128747,128747],[128748,128748],[128756,128764],[128992,129003],[129008,129008],[129292,129338],[129340,129349],[129351,129535],[129648,129652],[129656,129660],[129664,129670],[129680,129708],[129712,129722],[129728,129733],[129744,129753],[129760,129767],[129776,129782]],"Emoji_Modifier":[[127995,127999]],"Emoji_Modifier_Base":[[9757,9757],[9977,9977],[9994,9997],[127877,127877],[127938,127940],[127943,127943],[127946,127948],[128066,128066],[128067,128067],[128070,128080],[128102,128120],[128124,128124],[128129,128131],[128133,128135],[128143,128143],[128145,128145],[128170,128170],[128372,128372],[128373,128373],[128378,128378],[128400,128400],[128405,128405],[128406,128406],[128581,128583],[128587,128591],[128675,128675],[128692,128694],[128704,128704],[128716,128716],[129292,129292],[129295,129295],[129304,129311],[129318,129318],[129328,129337],[129340,129342],[129399,129399],[129461,129461],[129462,129462],[129464,129464],[129465,129465],[129467,129467],[129485,129487],[129489,129501],[129731,129733],[129776,129782]],"Emoji_Component":[[35,35],[42,42],[48,57],[8205,8205],[8419,8419],[65039,65039],[127462,127487],[127995,127999],[129456,129459],[917536,917631]],"Extended_Pictographic":[[169,169],[174,174],[8252,8252],[8265,8265],[8482,8482],[8505,8505],[8596,8601],[8617,8617],[8618,8618],[8986,8986],[8987,8987],[9000,9000],[9096,9096],[9167,9167],[9193,9203],[9208,9210],[9410,9410],[9642,9642],[9643,9643],[9654,9654],[9664,9664],[9723,9726],[9728,9733],[9735,9746],[9748,9861],[9872,9989],[9992,10002],[10004,10004],[10006,10006],[10013,10013],[10017,10017],[10024,10024],[10035,10035],[10036,10036],[10052,10052],[10055,10055],[10060,10060],[10062,10062],[10067,10069],[10071,10071],[10083,10087],[10133,10135],[10145,10145],[10160,10160],[10175,10175],[10548,10548],[10549,10549],[11013,11015],[11035,11035],[11036,11036],[11088,11088],[11093,11093],[12336,12336],[12349,12349],[12951,12951],[12953,12953],[126976,127231],[127245,127247],[127279,127279],[127340,127345],[127358,127358],[127359,127359],[127374,127374],[127377,127386],[127405,127461],[127489,127503],[127514,127514],[127535,127535],[127538,127546],[127548,127551],[127561,127994],[128000,128317],[128326,128591],[128640,128767],[128884,128895],[128981,129023],[129036,129039],[129096,129103],[129114,129119],[129160,129167],[129198,129279],[129292,129338],[129340,129349],[129351,129791],[130048,131069]]};

const names = Object.keys(scripts);
const ranges = Object.values(scripts);
const totals = new Array(names.length).fill(0);
const counts = new Array(names.length);

// Calculate the total number of codepoints for each script. We
// can easily do this by summing the number of codepoints in
// each range and script.
for (let i = 0; i < ranges.length; i++) {
  for (let j = 0; j < ranges[i].length; j++) {
    totals[i] += ranges[i][j][1] - ranges[i][j][0];
  }
}

function detect(codepoints) {
  // Reset the counts array
  counts.fill(0);

  for (let j = 0; j < codepoints.length; j++) {
    all:
    for (let i = 0; i < ranges.length; i++) {
      for (let k = 0; k < ranges[i].length; k++) {
        // Exit the outer loop (script) if the codepoint has been found.
        // The ranges don't repeat so we won't find the codepoint again.
        if (codepoints[j] >= ranges[i][k][0] && codepoints[j] <= ranges[i][k][1]) {
          counts[i]++;
          break all; // NOTE: This uses a label to jump out of both loops at once.
        }

        // Also exit the inner loop (ranges) early if the codepoint is smaller,
        // as we won't find the codepoint in subsequent ranges.
        if (ranges[i][k][0] > codepoints[j]) {
          break;
        }
      }
    }
  }

  const result = [];

  for (let i = 0; i < names.length; i++) {
    if (counts[i] !== 0) {
      result.push(names[i]);
    }
  }

  return result;
}

if (codepoints === null) {
  return false;
}

const writingScripts = detect(codepoints.map(c => parseInt(c, 10)));

if (writingScripts.length) {
  return true;
} else {
  return false;
}

""";
SELECT
  client,
  hasEmoji(JSON_EXTRACT_STRING_ARRAY(payload,
      '$._font_details.cmap.codepoints')) AS emoji,
  COUNT(0) AS total,
  COUNT(0) * 1.0 / SUM(COUNT(0)) OVER(PARTITION BY client) AS pct
FROM
  `httparchive.almanac.requests`
WHERE
  date = '2022-06-01'
  AND type = 'font' AND
  REGEXP_CONTAINS(JSON_EXTRACT(payload,
      '$._font_details.color.formats'), '(?i)(sbix|CBDT|SVG|COLRv0|COLRv1)')
GROUP BY
  client,
  emoji
